<!DOCTYPE html>
<html lang="en">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="author" content="Matt Makai">
    <meta name="description" content="How to build a simple Slack bot in Python tutorial.">
    <link rel="shortcut icon" href="/img/fsp-fav.png">
    <title>How to Build A Simple Slack Bot in Python - Full Stack Python</title>
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/libs/html5shiv/3.7.0/html5shiv.js"></script>
      <script src="https://oss.maxcdn.com/libs/respond.js/1.3.0/respond.min.js"></script>
    <![endif]-->
    <link href="/theme/css/f.min.css" rel="stylesheet">
</head>
<body>
    <a href="https://github.com/makaimc/fullstackpython.com"><img style="position: absolute; top: 0; right: 0; border: 0;" src="/img/fork.png" alt="Fork me on GitHub"></a>
    <div class="container">
<div class="row">
    <div class="col-md-12">
        <div class="logo-header-section">
            <a href="/" style="text-decoration: none; border: none;"><img src="/theme/img/logo.png" height="52" width="52" class="logo-image" style="padding-top: 1px;" alt="Full Stack Python logo"></a>
            <span class="logo-title"><a href="https://www.fullstackpython.com/">Full Stack Python</a></span>
        </div>
<div class="subnav">
    <!--<a href="/blog.html" class="submenu-item-first">Blog</a> |
    <a href="/books.html" class="submenu-item">Books</a> | -->
    <a href="/table-of-contents.html" class="submenu-item-first">All topics</a> | 
    <a href="/blog.html" class="submenu-item">Blog</a> |
    <a href="/email.html" class="submenu-item">Newsletter</a> |
    <a href="https://twitter.com/fullstackpython" class="submenu-item">@fullstackpython</a> |
    <a href="https://www.facebook.com/fullstackpython" class="submenu-item">Facebook</a> |
    <a href="https://github.com/makaimc/fullstackpython.com/tree/gh-pages/source" class="submenu-item">Source</a> 
</div>    </div>
</div><div class="row">
    <div class="col-md-12">
          <h1 class="blog-h1">How to Build A Simple Slack Bot in Python</h1>
          <div class="post-byline">
            Posted by <a href="/about-author.html">Matt Makai</a> on 
            June 01, 2016.
          </div>
          <p>Bots are a useful way to interact with chat services such as Slack.
If you have never built a bot before, this post provides an easy starter 
tutorial for combining the Slack API with Python to code your first bot.</p>
<p>We will walk through setting up your development environment, obtaining a
Slack API bot token and coding our simple bot in Python.</p>
<h2>Tools We Need</h2>
<p>Our bot, which we will name "StarterBot", requires Python and the Slack API.
To run our Python code we need:</p>
<ul>
<li>Either <a href="/python-2-or-3.html">Python 2 or 3</a></li>
<li>pip and virtualenv to handle Python application dependencies.</li>
<li>Free Slack account with a team on which you have API access or sign up 
  for the Slack Developer Hangout team</li>
<li>Official Python slackclient code library built by the Slack team</li>
<li>Slack API testing token</li>
</ul>
<p>It is also useful to have the Slack API docs handy while you're building this
tutorial.</p>
<h2>Establishing Our Environment</h2>
<p>We now know what tools we need for our project so let's dig in. Go to the 
terminal (or Command Prompt on Windows) and change into the directory 
where you want to store this project. Within that directory, create a new 
virtualenv to isolate our application dependencies from other Python 
projects.</p>
<div class="highlight"><pre>virtualenv starterbot
</pre></div>


<p>Activate the virtualenv:</p>
<div class="highlight"><pre>source starterbot/bin/activate
</pre></div>


<p>Your prompt should now look like the one in this screenshot.</p>
<p><img src="/source/static/img/160601-simple-python-slack-bot/virtualenv-activate.png" width="100%" class="technical-diagram img-rounded"></p>
<p>The official slackclient API helper library built by Slack can send and 
receive messages from a Slack channel. Install the slackclient library with 
the <code>pip</code> command:</p>
<div class="highlight"><pre>pip install slackclient
</pre></div>


<p>We also need to obtain an access token for our Slack team so our bot can
use it to connect to the Slack API.</p>
<h2>Slack Real Time Messaging (RTM) API</h2>
<p>Slack grants programmatic access to their messaging channels via a
<a href="/application-programming-interfaces.html">web API</a>. Go to the 
Slack web API page and sign up to create your own Slack team. You can
also sign into an existing account where you have administrative privileges.</p>
<p><img src="/source/static/img/160601-simple-python-slack-bot/sign-in-slack.png" width="100%" class="technical-diagram img-rounded"></p>
<p>After you have signed in go to the Bot Users page.</p>
<p><img src="/source/static/img/160601-simple-python-slack-bot/custom-bot-users.png" width="100%" class="technical-diagram img-rounded"></p>
<p>Call your bot "starterbot" then click the “Add bot integration” button.</p>
<p><img src="/source/static/img/160601-simple-python-slack-bot/starterbot.jpg" width="100%" class="technical-diagram img-rounded"></p>
<p>The page will reload and you will see a newly-generated access token. You 
can also change the logo to a custom design. For example, I gave this bot
the Full Stack Python logo.</p>
<p><img src="/source/static/img/160601-simple-python-slack-bot/slack-token.jpg" width="100%" class="technical-diagram img-rounded"></p>
<p>Click the "Save Integration" button at the bottom of the page. Your bot is 
now ready to connect to Slack's API.</p>
<p>A common practice for Python developers is to export secret tokens as 
environment variables. Export the Slack token with the name 
<code>SLACK_BOT_TOKEN</code>:</p>
<div class="highlight"><pre>export SLACK_BOT_TOKEN=&#39;your slack token pasted here&#39;
</pre></div>


<p>Nice, now we are authorized to use the Slack API as a bot.</p>
<p>There is one more piece of information we need to build our bot: our bot's 
ID. Next we will write a short script to obtain that ID from the Slack API.</p>
<h2>Obtaining Our Bot’s ID</h2>
<p>Finally, it's time to write some Python code! We'll get warmed up by coding 
a short Python script to obtain StarterBot's ID. The ID varies based on the 
Slack team. </p>
<p>We need the ID because it allows our application to determine if messages 
parsed from the Slack RTM are directed at StarterBot. Our script also 
tests that our <code>SLACK_BOT_TOKEN</code> environment variable is properly set. </p>
<p>Create a new file named <code>print_bot_id.py</code> and fill it with the following 
code.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">slackclient</span> <span class="kn">import</span> <span class="n">SlackClient</span>


<span class="n">BOT_NAME</span> <span class="o">=</span> <span class="s">&#39;starterbot&#39;</span>

<span class="n">slack_client</span> <span class="o">=</span> <span class="n">SlackClient</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;SLACK_BOT_TOKEN&#39;</span><span class="p">))</span>


<span class="k">if</span> <span class="n">__name__</span> <span class="o">==</span> <span class="s">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">api_call</span> <span class="o">=</span> <span class="n">slack_client</span><span class="o">.</span><span class="n">api_call</span><span class="p">(</span><span class="s">&quot;users.list&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">api_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;ok&#39;</span><span class="p">):</span>
        <span class="c"># retrieve all users so we can find our bot</span>
        <span class="n">users</span> <span class="o">=</span> <span class="n">api_call</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;members&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">user</span> <span class="ow">in</span> <span class="n">users</span><span class="p">:</span>
            <span class="k">if</span> <span class="s">&#39;name&#39;</span> <span class="ow">in</span> <span class="n">user</span> <span class="ow">and</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;name&#39;</span><span class="p">)</span> <span class="o">==</span> <span class="n">BOT_NAME</span><span class="p">:</span>
                <span class="k">print</span><span class="p">(</span><span class="s">&quot;Bot ID for &#39;&quot;</span> <span class="o">+</span> <span class="n">user</span><span class="p">[</span><span class="s">&#39;name&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="s">&quot;&#39; is &quot;</span> <span class="o">+</span> <span class="n">user</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s">&#39;id&#39;</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">print</span><span class="p">(</span><span class="s">&quot;could not find bot user with the name &quot;</span> <span class="o">+</span> <span class="n">BOT_NAME</span><span class="p">)</span>
</pre></div>


<p>Our code imports the SlackClient and instantiates it with our 
<code>SLACK_BOT_TOKEN</code>, which we set as an environment variable. When the 
script is executed by the <code>python</code> command we call the Slack API to list
all Slack users and get the ID for the one that matches the name "starterbot".</p>
<p>We only need to run this script once to obtain our bot’s ID.</p>
<div class="highlight"><pre>python print_bot_id.py
</pre></div>


<p>The script prints a single line of output when it is run that provides
us with our bot's ID.</p>
<p><img src="/source/static/img/160601-simple-python-slack-bot/print-bot-id.jpg" width="100%" class="technical-diagram img-rounded"></p>
<p>Copy the ID. Export the ID as an environment variable named <code>BOT_ID</code>.</p>
<div class="highlight"><pre>(starterbot)$ export BOT_ID=&#39;bot id returned by script&#39;
</pre></div>


<p>The script only needs to be run once to get the bot ID. We can now use
that ID in our Python application that will run StarterBot.</p>
<h2>Coding Our StarterBot</h2>
<p>We've got everything we need to write the StarterBot code. Create a new file 
named <code>starterbot.py</code> and include the following code in it.</p>
<div class="highlight"><pre><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">from</span> <span class="nn">slackclient</span> <span class="kn">import</span> <span class="n">SlackClient</span>
</pre></div>


<p>The <code>os</code> and <code>SlackClient</code> imports will look familiar because we used them 
in the <code>print_bot_id.py</code> program.</p>
<p>With our dependencies imported we can use them to obtain the environment 
variable values and then instantiate the Slack client.</p>
<div class="highlight"><pre><span class="cp"># starterbot&#39;s ID as an environment variable</span>
<span class="n">BOT_ID</span> <span class="o">=</span> <span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="s">&quot;BOT_ID&quot;</span><span class="p">)</span>

<span class="cp"># constants</span>
<span class="n">AT_BOT</span> <span class="o">=</span> <span class="s">&quot;&lt;@&quot;</span> <span class="o">+</span> <span class="n">BOT_ID</span> <span class="o">+</span> <span class="s">&quot;&gt;:&quot;</span>

<span class="cp"># instantiate Slack &amp; Twilio clients</span>
<span class="n">slack_client</span> <span class="o">=</span> <span class="n">SlackClient</span><span class="p">(</span><span class="n">os</span><span class="p">.</span><span class="n">environ</span><span class="p">.</span><span class="n">get</span><span class="p">(</span><span class="err">&#39;</span><span class="n">SLACK_BOT_TOKEN</span><span class="err">&#39;</span><span class="p">))</span>
</pre></div>


<p>The code instantiates the <code>SlackClient</code> client with our <code>SLACK_BOT_TOKEN</code> 
exported as an environment variable. </p>
<div class="highlight"><pre>if __name__ == &quot;__main__&quot;:
    READ_WEBSOCKET_DELAY = 1 # 1 second delay between reading from firehose
    if slack_client.rtm_connect():
        print(&quot;CallBot connected and running!&quot;)
        while True:
            command, channel = parse_slack_output(slack_client.rtm_read())
            if command and channel:
                handle_command(command, channel)
            time.sleep(READ_WEBSOCKET_DELAY)
    else:
        print(&quot;Connection failed. Invalid Slack token or bot ID?&quot;)
</pre></div>


<p>The Slack client connects to the Slack RTM API WebSocket then constantly 
loops while parsing messages from the firehose. If any of those messages are 
directed at our StarterBot, a function named <code>handle_command</code> determines what 
to do.</p>
<p>Next add two new functions to parse Slack output and handle commands.</p>
<div class="highlight"><pre><span class="nx">def</span> <span class="nx">handle_command</span><span class="p">(</span><span class="nx">command</span><span class="p">,</span> <span class="nx">channel</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        Receives commands directed at the bot and determines if they</span>
<span class="s2">        are valid commands. If so, then acts on the commands. If not,</span>
<span class="s2">        returns back what it needs for clarification.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nx">response</span> <span class="o">=</span> <span class="s2">&quot;Not sure what you mean. Use the *&quot;</span> <span class="o">+</span> <span class="err">\</span> 
               <span class="nx">CALL_COMMAND</span> <span class="o">+</span> <span class="s2">&quot;* command with numbers, delimited by spaces.&quot;</span>
    <span class="k">if</span> <span class="nx">command</span><span class="p">.</span><span class="nx">startswith</span><span class="p">(</span><span class="nx">CALL_COMMAND</span><span class="p">)</span><span class="o">:</span>
        <span class="nx">response</span> <span class="o">=</span> <span class="s2">&quot;calling stub...&quot;</span>
    <span class="nx">slack_client</span><span class="p">.</span><span class="nx">api_call</span><span class="p">(</span><span class="s2">&quot;chat.postMessage&quot;</span><span class="p">,</span> <span class="nx">channel</span><span class="o">=</span><span class="nx">channel</span><span class="p">,</span>
                          <span class="nx">text</span><span class="o">=</span><span class="nx">response</span><span class="p">,</span> <span class="nx">as_user</span><span class="o">=</span><span class="nx">True</span><span class="p">)</span>


<span class="nx">def</span> <span class="nx">parse_slack_output</span><span class="p">(</span><span class="nx">slack_rtm_output</span><span class="p">)</span><span class="o">:</span>
    <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">        The Slack Real Time Messaging API is a firehose of data, so</span>
<span class="s2">        this parsing function returns None unless a message is</span>
<span class="s2">        directed at the Bot, based on its ID.</span>
<span class="s2">    &quot;&quot;&quot;</span>
    <span class="nx">output_list</span> <span class="o">=</span> <span class="nx">slack_rtm_output</span>
    <span class="k">if</span> <span class="nx">output_list</span> <span class="nx">and</span> <span class="nx">len</span><span class="p">(</span><span class="nx">output_list</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">:</span>
        <span class="k">for</span> <span class="nx">output</span> <span class="k">in</span> <span class="nx">output_list</span><span class="o">:</span>
            <span class="k">if</span> <span class="nx">output</span> <span class="nx">and</span> <span class="s1">&#39;text&#39;</span> <span class="k">in</span> <span class="nx">output</span> <span class="nx">and</span> <span class="nx">AT_BOT</span> <span class="k">in</span> <span class="nx">output</span><span class="cp">[</span><span class="s1">&#39;text&#39;</span><span class="cp">]</span><span class="o">:</span>
                <span class="err">#</span> <span class="k">return</span> <span class="nx">text</span> <span class="nx">after</span> <span class="nx">the</span> <span class="err">@</span> <span class="nx">mention</span><span class="p">,</span> <span class="nx">whitespace</span> <span class="nx">removed</span>
                <span class="k">return</span> <span class="nx">output</span><span class="cp">[</span><span class="s1">&#39;text&#39;</span><span class="cp">]</span><span class="p">.</span><span class="nx">split</span><span class="p">(</span><span class="nx">AT_BOT</span><span class="p">)</span><span class="cp">[</span><span class="mi">1</span><span class="cp">]</span><span class="p">.</span><span class="nx">strip</span><span class="p">(),</span> 
                       <span class="nx">output</span><span class="cp">[</span><span class="s1">&#39;channel&#39;</span><span class="cp">]</span>
    <span class="k">return</span> <span class="nx">None</span><span class="p">,</span> <span class="nx">None</span>
</pre></div>


<p>The <code>parse_slack_output</code> function takes messages from Slack and determines 
if they are directed at our StarterBot. Messages that start with a direct
command to our bot ID are then handled by our code - which is currently
just a stub function.</p>
<p>Now that all of our code is in place we can run our StarterBot on the 
command line with the <code>python starterbot.py</code> command.</p>
<p>starterbot-running.png</p>
<p>In Slack, start giving StarterBot commands.</p>
<p>working-starterbot</p>
<h2>Wrapping Up</h2>
<p>Alright, our simple StarterBot is all done! There's a lot more that we
could do using the Slack RTM API and our Python code. Check out these posts 
to learn what you could do:</p>
<p>Implement a persistent backend like PostgreSQL and use it to store a phone number for each username
Add SMS capability to the bot
Use Twilio Lookup to determine if a number is truly valid instead of just parseable
Boost the parser with better parsing and natural language processing so it’s more natural for Slack users to interact with</p>
          <hr>
<div id="mc_embed_signup">
<form action="//mattmakai.us2.list-manage.com/subscribe/post?u=b7e774f0c4f05dcebbfee183d&amp;id=b22335388d" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
    <div id="mc_embed_signup_scroll">
        <h4>Sign up here to receive a monthly email with major updates to this site, tutorials and discount codes for Python books.</h4>
        <div class="row">
            <div class="col-md-9">
                <input type="email" value="" name="EMAIL" class="email form-control" id="mce-EMAIL" placeholder="email address" required>
                <div style="position: absolute; left: -5000px;"><input type="text" name="b_b7e774f0c4f05dcebbfee183d_b22335388d" tabindex="-1" value=""></div>
            </div>
            <div class="col-md-3">
                <div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="btn btn-success" style="font-family: 'Helvetica Neue';"></div>
            </div>
        </div>
    </div>
</form>
</div>
    </div>
</div>
        <hr/>
    </div> 
<div style="padding: 0 0 20px 0; margin: 0 0 20px 0; background-color: #22B24C;">
    <div class="container">
        <p class="banner"><a href="https://www.gumroad.com/l/python-deployments" style="color: #fff">Learning web development? Check out The Full Stack Python Guide to Deployments book</a>!</p>
    </div>
</div>    <div class="container">
        <div class="footer pull-right">
            <a href="http://www.mattmakai.com/" class="underline">Matt Makai</a>
            2016
        </div>
    </div>
<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-19910497-7', 'auto');
  ga('send', 'pageview');
</script>

<script type='text/javascript'>
    var trackOutboundLink = function(url) { ga('send', 'event', 'outbound', 'click', url, {'hitCallback': function () { document.location = url; } }); }
</script>
</body>
</html>